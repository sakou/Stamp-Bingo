# システム設計書

## 1. ドキュメント情報

| 項目 | 詳細 |
|:---|:---|
| **プロジェクト名** | 4店舗合同 ビンゴスタンプラリー |
| **バージョン** | 1.0 |
| **作成日** | 2025-10-25 |
| **最終更新日** | 2025-10-25 |
| **対象システム** | Next.js実装版（本番環境） |

---

## 2. システム概要

### 2-1. システムの目的

4店舗のコラボ企画を通じた集客促進と顧客回遊の活性化を実現するデジタルビンゴスタンプラリーシステム。イベント単位で管理され、QRコードベースの訪問記録により5×5ビンゴゲームを提供する。

### 2-2. 主要機能

| 機能分類 | 機能名 | 概要 |
|:---|:---|:---|
| **利用者機能** | ビンゴカード表示 | 5×5ビンゴカードと達成状況のリアルタイム表示 |
| | スタンプ獲得 | QRコードスキャンによる訪問記録と進捗更新 |
| | ビンゴ判定 | ライン達成時の自動判定と景品情報表示 |
| **管理者機能** | イベント管理 | イベント作成・編集・公開管理 |
| | 店舗情報設定 | 4店舗の情報・SNSリンク設定 |
| | 景品設定 | 3段階の景品情報設定 |
| | QRコード生成 | イベントIDを含むQRコード生成 |
| | 統計閲覧 | 参加者数・ビンゴ達成数の確認 |

---

## 3. システムアーキテクチャ

### 3-1. 全体アーキテクチャ

```
┌─────────────────────────────────────────────────────────┐
│                     ユーザー                              │
│              (iPhone/Android Browser)                    │
└──────────────────┬──────────────────────────────────────┘
                   │ HTTPS
                   ▼
┌─────────────────────────────────────────────────────────┐
│                  Vercel Edge Network                     │
│                  (CDN + SSL/TLS)                         │
└──────────────────┬──────────────────────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────────────────────┐
│              Next.js 16 Application                      │
│                (App Router)                              │
│  ┌──────────────────────────────────────────────────┐  │
│  │  Pages (RSC: React Server Components)           │  │
│  │  - /               ビンゴカード表示              │  │
│  │  - /admin          管理者ダッシュボード          │  │
│  │  - /api/*          API Routes                    │  │
│  └──────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────┐  │
│  │  Server Actions                                   │  │
│  │  - スタンプ獲得処理                              │  │
│  │  - イベント管理処理                              │  │
│  │  - 景品設定処理                                  │  │
│  └──────────────────────────────────────────────────┘  │
└──────────────────┬──────────────────────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────────────────────┐
│            Vercel Postgres (PostgreSQL)                  │
│  - events テーブル                                       │
│  - stores テーブル                                       │
│  - prizes テーブル                                       │
│  - user_progress テーブル                               │
│  - bingo_achievements テーブル                          │
└─────────────────────────────────────────────────────────┘
```

### 3-2. アーキテクチャパターン

| パターン | 採用理由 |
|:---|:---|
| **App Router** | Next.js 16の最新ルーティングシステム。RSC（React Server Components）によるサーバーサイドレンダリングとクライアントサイドの最適な分離 |
| **Server Actions** | フォーム送信やデータ更新をサーバーサイドで直接処理。APIエンドポイント不要でセキュア |
| **Static Site Generation (SSG)** | イベント情報ページなど変更頻度の低いページは静的生成 |
| **Incremental Static Regeneration (ISR)** | イベント情報の変更を一定時間後に反映（revalidate設定） |
| **Client Components** | ビンゴカードのインタラクティブ操作など、クライアントサイドが必要な部分のみ使用 |

### 3-3. レンダリング戦略

| ページ | レンダリング方式 | 理由 |
|:---|:---|:---|
| `/` (ビンゴカード) | ISR (revalidate: 60) | イベント情報の変更を1分以内に反映、高速表示 |
| `/admin` (管理画面) | SSR (Server Side Rendering) | 常に最新データが必要、認証必須 |
| `/api/*` (API Routes) | Edge Runtime | グローバル展開、低レイテンシ |

---

## 4. 技術スタック

### 4-1. フロントエンド

| 技術 | バージョン | 用途 |
|:---|:---|:---|
| **Next.js** | 16.x | フレームワーク |
| **React** | 19.x | UIライブラリ |
| **TypeScript** | 5.x | 型安全性確保 |
| **Tailwind CSS** | 4.x | スタイリング |
| **Font Awesome** | 6.5.1 | アイコン表示（SNSアイコン） |

### 4-2. バックエンド

| 技術 | バージョン | 用途 |
|:---|:---|:---|
| **Next.js Server Actions** | - | サーバーサイドロジック |
| **Vercel Postgres** | - | データベース（PostgreSQL） |
| **Prisma** | 6.x | ORMツール |

### 4-3. インフラ・デプロイ

| 技術 | 用途 |
|:---|:---|
| **Vercel** | ホスティング・デプロイプラットフォーム |
| **Vercel Edge Network** | CDN・SSL/TLS終端 |
| **GitHub** | ソースコード管理 |
| **GitHub Actions** | CI/CDパイプライン（オプション） |

### 4-4. 開発ツール

| 技術 | 用途 |
|:---|:---|
| **ESLint** | コード品質チェック |
| **Prettier** | コードフォーマッター |
| **Husky** | Git hooksによるコミット前チェック |
| **Jest** | ユニットテスト |
| **Playwright** | E2Eテスト（オプション） |

---

## 5. データフロー

### 5-1. スタンプ獲得フロー

```
[ユーザー]
    │
    │ ① QRコードスキャン
    │    (?event={event_id}&store={store_id})
    ▼
[Next.js Page]
    │
    │ ② URLパラメータ解析
    │
    ▼
[Server Action: processStamp]
    │
    │ ③ イベント有効性確認
    │ ④ ユーザー識別（Cookie/UUID）
    │ ⑤ 訪問回数カウント
    │ ⑥ データベース更新
    │
    ▼
[Database: user_progress]
    │
    │ ⑦ ビンゴ判定ロジック実行
    │
    ▼
[Server Action: checkBingo]
    │
    │ ⑧ 達成ライン数判定
    │ ⑨ 景品情報取得
    │
    ▼
[Response]
    │
    │ ⑩ クライアント側で画面更新
    │    - ビンゴカード表示更新
    │    - 景品情報モーダル表示（ライン達成時）
    ▼
[ユーザー]
```

### 5-2. 管理者イベント作成フロー

```
[管理者]
    │
    │ ① イベント情報入力
    │    - 基本情報（名称、期間、説明）
    │    - 店舗情報（4店舗）
    │    - 参加条件
    │    - 景品設定（3段階）
    ▼
[管理画面: /admin]
    │
    │ ② フォーム送信
    │
    ▼
[Server Action: createEvent]
    │
    │ ③ バリデーション
    │    - 必須項目チェック
    │    - 日付妥当性チェック
    │    - アクティブイベント重複チェック
    │
    ▼
[Database Transaction]
    │
    │ ④ events テーブル挿入
    │ ⑤ stores テーブル挿入（4件）
    │ ⑥ prizes テーブル挿入（3件）
    │ ⑦ QRコード用URL生成
    │
    ▼
[Response]
    │
    │ ⑧ QRコード生成画面表示
    │    - 4種類のQRコード（A/B/C/D店）
    │    - ダウンロード・印刷機能
    ▼
[管理者]
```

---

## 6. セキュリティ設計

### 6-1. 通信セキュリティ

| 項目 | 対策 |
|:---|:---|
| **SSL/TLS** | Vercel標準でHTTPS通信を強制（Let's Encrypt証明書） |
| **HSTS** | Strict-Transport-Securityヘッダーでブラウザ側でHTTPS強制 |
| **CSP** | Content-Security-Policyでスクリプト実行元を制限 |

### 6-2. 認証・認可

| 項目 | 実装方針 |
|:---|:---|
| **管理者認証** | NextAuth.js v5を使用した認証（パスワードベース） |
| **セッション管理** | JWT（JSON Web Token）を使用 |
| **権限管理** | 管理者ページへのアクセス制限（middleware.ts） |
| **ユーザー識別** | UUID自動生成 + Cookie保存（認証不要） |

### 6-3. データ保護

| 項目 | 対策 |
|:---|:---|
| **個人情報** | Instagram IDは任意入力、最小限の情報のみ収集 |
| **SQL Injection** | Prisma ORMによる自動エスケープ |
| **XSS** | Reactの自動エスケープ機能を活用 |
| **CSRF** | Next.js Server Actionsの自動CSRF保護 |

### 6-4. QRコード検証

| 項目 | 対策 |
|:---|:---|
| **イベントID検証** | データベース照合でイベント存在確認 |
| **期間検証** | イベント開催期間内のみスタンプ獲得可能 |
| **レート制限** | 同一ユーザーの連続スキャン制限（1分に1回まで） |
| **店舗ID検証** | 許可された店舗ID（A/B/C/D）のみ受付 |

---

## 7. パフォーマンス設計

### 7-1. フロントエンド最適化

| 項目 | 実装 |
|:---|:---|
| **画像最適化** | Next.js Image コンポーネント使用（WebP変換、遅延読み込み） |
| **コード分割** | dynamic importによる動的インポート（モーダルなど） |
| **フォント最適化** | next/fontによるGoogle Fonts最適化 |
| **CSS最適化** | Tailwind CSSのPurge機能で未使用スタイル削除 |

### 7-2. バックエンド最適化

| 項目 | 実装 |
|:---|:---|
| **データベース接続プーリング** | Prismaの接続プーリング活用 |
| **クエリ最適化** | N+1問題回避のためinclude/selectを適切に使用 |
| **インデックス設計** | event_id、user_id、created_atにインデックス設定 |
| **キャッシング** | ISRによる静的ページキャッシング（60秒） |

### 7-3. パフォーマンス目標

| 指標 | 目標値 |
|:---|:---|
| **First Contentful Paint (FCP)** | < 1.8秒 |
| **Largest Contentful Paint (LCP)** | < 2.5秒 |
| **Cumulative Layout Shift (CLS)** | < 0.1 |
| **スタンプ獲得処理** | < 3秒 |
| **ページ遷移** | < 1秒 |

---

## 8. エラーハンドリング

### 8-1. エラー分類と対応

| エラー分類 | 例 | 対応 |
|:---|:---|:---|
| **バリデーションエラー** | 必須項目未入力、不正な日付 | フォーム内にエラーメッセージ表示 |
| **ビジネスロジックエラー** | イベント期間外のスタンプ獲得 | ユーザーフレンドリーなメッセージ表示 |
| **データベースエラー** | 接続失敗、タイムアウト | リトライ機能 + エラーページ表示 |
| **システムエラー** | 予期しないエラー | Error Boundary + Sentry連携（オプション） |

### 8-2. エラーログ設計

```typescript
// エラーログ構造
interface ErrorLog {
  timestamp: Date;
  level: 'error' | 'warning' | 'info';
  userId?: string;
  eventId?: string;
  message: string;
  stack?: string;
  context: Record<string, any>;
}
```

---

## 9. 監視・運用設計

### 9-1. ログ収集

| ログ種別 | 内容 | 保存先 |
|:---|:---|:---|
| **アクセスログ** | ページアクセス、APIコール | Vercel Analytics |
| **エラーログ** | システムエラー、例外 | Vercel Logs / Sentry |
| **ビジネスログ** | スタンプ獲得、ビンゴ達成 | Database (logs テーブル) |

### 9-2. 監視項目

| 項目 | 監視内容 | アラート条件 |
|:---|:---|:---|
| **稼働率** | サービス死活監視 | ダウン検知 |
| **レスポンスタイム** | APIレスポンス時間 | 平均3秒超過 |
| **エラー率** | 5xx/4xxエラー発生率 | 5%超過 |
| **データベース接続** | 接続プール使用率 | 80%超過 |

### 9-3. バックアップ戦略

| 対象 | 頻度 | 保存期間 |
|:---|:---|:---|
| **データベース** | 日次自動バックアップ（Vercel標準） | 30日間 |
| **ユーザー進捗データ** | リアルタイム（PostgreSQLレプリケーション） | - |
| **イベントデータ** | 手動バックアップ（イベント終了時） | 1年間 |

---

## 10. デプロイ戦略

### 10-1. デプロイフロー

```
[開発環境]
    │
    │ git push to feature branch
    ▼
[GitHub]
    │
    │ Pull Request作成
    ▼
[Vercel Preview Deploy]
    │
    │ プレビュー環境での動作確認
    │ レビュー・承認
    ▼
[main branchへマージ]
    │
    │ 自動トリガー
    ▼
[Vercel Production Deploy]
    │
    │ 本番環境へ自動デプロイ
    ▼
[本番環境]
```

### 10-2. 環境分離

| 環境 | 用途 | URL | データベース |
|:---|:---|:---|:---|
| **Development** | ローカル開発 | localhost:3000 | SQLite |
| **Preview** | PR確認・ステージング | xxx-preview.vercel.app | Vercel Postgres (Dev) |
| **Production** | 本番環境 | bingo.example.com | Vercel Postgres (Prod) |

### 10-3. 環境変数管理

```bash
# .env.local (Gitにコミットしない)
DATABASE_URL="postgresql://..."
NEXTAUTH_SECRET="xxx"
NEXTAUTH_URL="https://..."
```

Vercelダッシュボードで環境ごとに設定。

---

## 11. スケーラビリティ設計

### 11-1. 想定負荷

| 項目 | 想定値 |
|:---|:---|
| **同時接続ユーザー数** | 100人/イベント |
| **ピーク時アクセス** | 20リクエスト/秒 |
| **データベースサイズ** | < 1GB/年 |
| **ストレージ** | < 100MB（画像・静的ファイル） |

### 11-2. スケーリング戦略

| 項目 | 戦略 |
|:---|:---|
| **水平スケーリング** | Vercelのオートスケーリング機能を活用 |
| **データベース** | Vercel Postgresのコネクションプーリング活用 |
| **キャッシュ** | ISR + Edge Cachingでデータベース負荷軽減 |
| **静的ファイル** | Vercel Edge NetworkでCDN配信 |

---

## 12. 技術的制約・前提条件

### 12-1. 制約事項

| 項目 | 制約 |
|:---|:---|
| **ブラウザ対応** | Chrome, Safari, Edge 最新版（モダンブラウザのみ） |
| **モバイル対応** | iOS 14+, Android 10+ |
| **JavaScript** | 必須（JavaScriptオフ環境は非対応） |
| **Cookie** | 必須（ユーザー識別に使用） |

### 12-2. 前提条件

| 項目 | 前提 |
|:---|:---|
| **店舗数** | 固定4店舗（拡張不可） |
| **同時イベント** | 1イベントのみ（並列実施不可） |
| **QRコード** | ユーザーが自分のスマホでスキャン |
| **インターネット接続** | 必須（オフライン動作は非対応） |

---

## 13. 今後の拡張性

### 13-1. Phase 2 機能候補

| 機能 | 概要 | 優先度 |
|:---|:---|:---|
| **Instagram ID連携** | Instagram ID入力による統計強化 | 中 |
| **景品引換管理** | 引換済みフラグのシステム管理 | 高 |
| **プッシュ通知** | ビンゴ達成時の通知機能 | 低 |
| **多言語対応** | 英語・中国語対応 | 低 |

### 13-2. アーキテクチャ拡張ポイント

- **マイクロサービス化**: 規模拡大時にイベント管理・統計機能を分離
- **GraphQL導入**: 複雑なクエリ要件が増えた場合
- **WebSocket**: リアルタイムランキング機能追加時

---

## 14. 変更履歴

| 日付 | バージョン | 変更内容 | 作成者 |
|:---|:---|:---|:---|
| 2025-10-25 | 1.0 | 初版作成 | - |
